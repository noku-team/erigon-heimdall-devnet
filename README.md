# Setting Up a Local Polygon Chain

## Heimdall Validator Node Configuration

### Installation

Clone the latest release from [Github](https://github.com/maticnetwork/heimdall/releases) and install Heimdall by following the instructions in the README.

### First Node Configuration

Initialize the first node in the data directory with the following command:

```bash
./bin/heimdalld init --chain-id=heimdall-erigon-<chainid> --chain=local --home=./heimdalld_data
```

This will create a [genesis.json](./heimdall_data/config/genesis.json) file with default configurations for Heimdall. Modify the validator and proposer values using the data generated by the second Heimdall node (if two validators are needed). To generate the required data, use the provided [scripts](./scripts/README.md).

Example of a Heimdall genesis file with two validators:

```json
{
  "genesis_time": "2025-01-22T11:12:59.787707Z",
  "chain_id": "erigon-test-2999",
  "consensus_params": {
    "block": {
      "max_bytes": "22020096",
      "max_gas": "-1",
      "time_iota_ms": "1000"
    },
    "evidence": {
      "max_age": "100000"
    },
    "validator": {
      "pub_key_types": [
        "secp256k1"
      ]
    }
  },
  "app_hash": "",
  "app_state": {
    "auth": {
      "params": {
        "max_memo_characters": "256",
        "tx_sig_limit": "7",
        "tx_size_cost_per_byte": "10",
        "sig_verify_cost_ed25519": "590",
        "sig_verify_cost_secp256k1": "1000",
        "max_tx_gas": "1000000",
        "tx_fees": "1000000000000000"
      },
      "accounts": [
        {
          "address": "0x048d975e40d9d9e8931b9ec38f404b8e36be3218",
          "coins": [
            {
              "denom": "matic",
              "amount": "1000000000000000000000"
            }
          ],
          "sequence_number": "0",
          "account_number": "0",
          "module_name": "",
          "module_permissions": null
        },
        {
          "address": "0xf5e55a3e66d028c59c12185e2e51cdafe2c53baf",
          "coins": [
            {
              "denom": "matic",
              "amount": "1000000000000000000000"
            }
          ],
          "sequence_number": "0",
          "account_number": "1",
          "module_name": "",
          "module_permissions": null
        }
      ]
    },
    "bank": {
      "send_enabled": true
    },
    "bor": {
      "params": {
        "sprint_duration": "20",
        "span_duration": "2000",
        "producer_count": "4"
      },
      "spans": [
        {
          "span_id": "0",
          "start_block": "0",
          "end_block": "255",
          "validator_set": {
            "validators": [
              {
                "ID": "1",
                "startEpoch": "0",
                "endEpoch": "0",
                "nonce": "1",
                "power": "1",
                "pubKey": "0x043245d66efca79886088e3e454a6b12a7808a9441566a24a49db062847d8a975734ef6c81d9fd14b53f4cf4499fad5111c86c9913725e7b939977875fdd6c712c",
                "signer": "0x048d975e40d9d9e8931b9ec38f404b8e36be3218",
                "last_updated": "",
                "jailed": false,
                "accum": "0"
              },
              {
                "ID": "2",
                "startEpoch": "0",
                "endEpoch": "0",
                "nonce": "1",
                "power": "1",
                "pubKey": "0x0432541a747bd596a7b4ee70981b086485cffb9ef25c5d94c716cdecebddbf2768709b069b95ee9dba5d8306bb7253c10020765a8f4dbc418a95f70c0f2709947d",
                "signer": "0xf5e55a3e66d028c59c12185e2e51cdafe2c53baf",
                "last_updated": "",
                "jailed": false,
                "accum": "0"
              }
            ],
            "proposer": {
              "ID": "1",
              "startEpoch": "0",
              "endEpoch": "0",
              "nonce": "1",
              "power": "1",
              "pubKey": "0x043245d66efca79886088e3e454a6b12a7808a9441566a24a49db062847d8a975734ef6c81d9fd14b53f4cf4499fad5111c86c9913725e7b939977875fdd6c712c",
              "signer": "0x048d975e40d9d9e8931b9ec38f404b8e36be3218",
              "last_updated": "",
              "jailed": false,
              "accum": "0"
            }
          },
          "selected_producers": [
            {
              "ID": "1",
              "startEpoch": "0",
              "endEpoch": "0",
              "nonce": "1",
              "power": "1",
              "pubKey": "0x043245d66efca79886088e3e454a6b12a7808a9441566a24a49db062847d8a975734ef6c81d9fd14b53f4cf4499fad5111c86c9913725e7b939977875fdd6c712c",
              "signer": "0x048d975e40d9d9e8931b9ec38f404b8e36be3218",
              "last_updated": "",
              "jailed": false,
              "accum": "0"
            },
            {
              "ID": "2",
              "startEpoch": "0",
              "endEpoch": "0",
              "nonce": "1",
              "power": "1",
              "pubKey": "0x0432541a747bd596a7b4ee70981b086485cffb9ef25c5d94c716cdecebddbf2768709b069b95ee9dba5d8306bb7253c10020765a8f4dbc418a95f70c0f2709947d",
              "signer": "0xf5e55a3e66d028c59c12185e2e51cdafe2c53baf",
              "last_updated": "",
              "jailed": false,
              "accum": "0"
            }
          ],
          "bor_chain_id": "2999"
        }
      ]
    },
    "chainmanager": {
      "params": {
        "mainchain_tx_confirmations": "6",
        "maticchain_tx_confirmations": "10",
        "chain_params": {
          "bor_chain_id": "2999",
          "matic_token_address": "0x0000000000000000000000000000000000000000",
          "staking_manager_address": "0x0000000000000000000000000000000000000000",
          "slash_manager_address": "0x0000000000000000000000000000000000000000",
          "root_chain_address": "0x0000000000000000000000000000000000000000",
          "staking_info_address": "0x0000000000000000000000000000000000000000",
          "state_sender_address": "0x0000000000000000000000000000000000000000",
          "state_receiver_address": "0x0000000000000000000000000000000000001001",
          "validator_set_address": "0x0000000000000000000000000000000000001000"
        }
      }
    },
    "checkpoint": {
      "params": {
        "checkpoint_buffer_time": "1000000000000",
        "avg_checkpoint_length": "256",
        "max_checkpoint_length": "1024",
        "child_chain_block_interval": "10000"
      },
      "buffered_checkpoint": null,
      "last_no_ack": "0",
      "ack_count": "0",
      "checkpoints": null
    },
    "clerk": {
      "event_records": [],
      "record_sequences": null
    },
    "gov": {
      "starting_proposal_id": "1",
      "deposits": null,
      "votes": null,
      "proposals": null,
      "deposit_params": {
        "min_deposit": [
          {
            "denom": "matic",
            "amount": "10000000000000000000"
          }
        ],
        "max_deposit_period": "172800000000000"
      },
      "voting_params": {
        "voting_period": "172800000000000"
      },
      "tally_params": {
        "quorum": "0.334000000000000000",
        "threshold": "0.500000000000000000",
        "veto": "0.334000000000000000"
      }
    },
    "params": null,
    "sidechannel": {
      "past_commits": []
    },
    "slashing": {
      "params": {
        "signed_blocks_window": "100",
        "min_signed_per_window": "0.500000000000000000",
        "downtime_jail_duration": "600000000000",
        "slash_fraction_double_sign": "0.050000000000000000",
        "slash_fraction_downtime": "0.010000000000000000",
        "slash_fraction_limit": "0.333333333333333333",
        "jail_fraction_limit": "0.333333333333333333",
        "max_evidence_age": "120000000000",
        "enable_slashing": false
      },
      "signing_infos": {
        "1": {
          "valID": "1",
          "startHeight": "0",
          "indexOffset": "0"
        }
      },
      "missed_blocks": {},
      "buffer_val_slash_info": null,
      "tick_val_slash_info": null,
      "tick_count": "0"
    },
    "staking": {
      "validators": [
        {
          "ID": "1",
          "startEpoch": "0",
          "endEpoch": "0",
          "nonce": "1",
          "power": "1",
          "pubKey": "0x043245d66efca79886088e3e454a6b12a7808a9441566a24a49db062847d8a975734ef6c81d9fd14b53f4cf4499fad5111c86c9913725e7b939977875fdd6c712c",
          "signer": "0x048d975e40d9d9e8931b9ec38f404b8e36be3218",
          "last_updated": "",
          "jailed": false,
          "accum": "0"
        },
        {
          "ID": "2",
          "startEpoch": "0",
          "endEpoch": "0",
          "nonce": "1",
          "power": "1",
          "pubKey": "0x0432541a747bd596a7b4ee70981b086485cffb9ef25c5d94c716cdecebddbf2768709b069b95ee9dba5d8306bb7253c10020765a8f4dbc418a95f70c0f2709947d",
          "signer": "0xf5e55a3e66d028c59c12185e2e51cdafe2c53baf",
          "last_updated": "",
          "jailed": false,
          "accum": "0"
        }
      ],
      "current_val_set": {
        "validators": [
          {
            "ID": "1",
            "startEpoch": "0",
            "endEpoch": "0",
            "nonce": "1",
            "power": "1",
            "pubKey": "0x043245d66efca79886088e3e454a6b12a7808a9441566a24a49db062847d8a975734ef6c81d9fd14b53f4cf4499fad5111c86c9913725e7b939977875fdd6c712c",
            "signer": "0x048d975e40d9d9e8931b9ec38f404b8e36be3218",
            "last_updated": "",
            "jailed": false,
            "accum": "0"
          },
          {
            "ID": "2",
            "startEpoch": "0",
            "endEpoch": "0",
            "nonce": "1",
            "power": "1",
            "pubKey": "0x0432541a747bd596a7b4ee70981b086485cffb9ef25c5d94c716cdecebddbf2768709b069b95ee9dba5d8306bb7253c10020765a8f4dbc418a95f70c0f2709947d",
            "signer": "0xf5e55a3e66d028c59c12185e2e51cdafe2c53baf",
            "last_updated": "",
            "jailed": false,
            "accum": "0"
          }
        ],
        "proposer": {
          "ID": "1",
          "startEpoch": "0",
          "endEpoch": "0",
          "nonce": "1",
          "power": "1",
          "pubKey": "0x043245d66efca79886088e3e454a6b12a7808a9441566a24a49db062847d8a975734ef6c81d9fd14b53f4cf4499fad5111c86c9913725e7b939977875fdd6c712c",
          "signer": "0x048d975e40d9d9e8931b9ec38f404b8e36be3218",
          "last_updated": "",
          "jailed": false,
          "accum": "0"
        }
      },
      "staking_sequences": null
    },
    "supply": {
      "supply": {
        "total": []
      }
    },
    "topup": {
      "tx_sequences": null,
      "dividend_accounts": [
        {
          "user": "0x048d975e40d9d9e8931b9ec38f404b8e36be3218",
          "feeAmount": "0"
        },
        {
          "user": "0xf5e55a3e66d028c59c12185e2e51cdafe2c53baf",
          "feeAmount": "0"
        }
      ]
    }
  }
}

```

--------------------------------------------

We also need to replace all occurrences of `bor_chain_id` with the `chain_id` we choose for Erigon/Bor.

--------------------------------------------

By default, the node will run its P2P service on port 26656 and its RPC service on port 26657. To change these configurations, modify the [config.toml](./heimdalld_data/config/config.toml) file in the `heimdalld_data/config/` directory.

Next, adjust the Heimdall configuration parameters as needed in the [heimdall-config.toml](./heimdalld_data/config/heimdall-config.toml) file.

Now, start the first node using the following command:

```bash
./bin/heimdalld start --home=./heimdalld_data
```

Then, launch the REST server with:

```bash
./bin/heimdalld rest-server --home=./heimdalld_data --laddr=tcp://0.0.0.0:1317 --node=tcp://localhost:26657
```

### Additional Node Configuration

To initialize an additional node, copy the configurations from the first node and modify them so that the new node connects to the main node. The example below is for a second node. First, initialize it with:

```bash
./bin/heimdalld init --chain-id=heimdall-erigon-<chainid> --chain=local --home=./heimdalld_data2
```

Update the main [genesis.json](./heimdalld_data/config/genesis.json) file with this validator’s data if you plan to have multiple validators.

Copy the [genesis.json](./heimdalld_data/config/genesis.json) file from the `heimdalld_data/config/` directory to `heimdalld_data2/config/`.

Modify the [config.toml](./heimdalld_data2/config/config.toml) file in `heimdalld_data2/config/` by changing the `seeds` value to the main node's ID (retrieved from [this](http://localhost:26657/status?) endpoint) and IP address. Example:

```toml
seeds = "f1b1c1b1d1b1e1b1f1b1g1b1@127.0.0.1:26656"
```

Additionally, update the service ports (P2P, RPC, and gRPC), for example:

```toml
prof_laddr = "localhost:6061"

[p2p]
laddr = "tcp://0.0.0.0:26658"

[rpc]
laddr = "tcp://127.0.0.1:26659"
```

Now, start the second node using the following command:

```bash
./bin/heimdalld start --home=./heimdalld_data2
```

Then, launch the REST server with:

```bash
./bin/heimdalld rest-server --home=./heimdalld_data2 --laddr=tcp://0.0.0.0:1318 --node=tcp://localhost:26659 --grpc-addr 0.0.0.0:3133
```

At this point, the second node will connect to the first node, and you will be able to see the blocks produced by the second node in the first node. To verify the correct connection, check the main node’s logs and the network status at the following endpoint: [http://localhost:26657/net_info](http://localhost:26657/net_info).

## Genesis Configuration

Configure the [genesis.json](./erigon_data/genesis.json) file with the Heimdall validator data and the selected `chain_id` values. Here is an example:

```json
{
 "config": {
  "chainId": 2999, // chain_id scelto
  "homesteadBlock": 0,
  "eip150Block": 0,
  "eip150Hash": "0x0000000000000000000000000000000000000000000000000000000000000000",
  "eip155Block": 0,
  "eip158Block": 0,
  "byzantiumBlock": 0,
  "constantinopleBlock": 0,
  "petersburgBlock": 0,
  "istanbulBlock": 0,
  "muirGlacierBlock": 0,
  "berlinBlock": 0,
  "londonBlock": 0,
  "shanghaiBlock": 0,
  "cancunBlock": 0,
  "bor": {
   "jaipurBlock": 0,
   "delhiBlock": 0,
   "indoreBlock": 0,
   "period": {
    "0": 2
   },
   "producerDelay": {
    "0": 4
   },
   "sprint": {
    "0": 16
   },
   "backupMultiplier": {
    "0": 2
   },
   "validatorContract": "0x0000000000000000000000000000000000001000",
   "stateReceiverContract": "0x0000000000000000000000000000000000001001"
  }
 },
 "nonce": "0x0",
 "timestamp": "0x5ce28211",
 "extraData": "",
 "gasLimit": "0x989680",
 "difficulty": "0x1",
 "mixHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
 "coinbase": "0x0000000000000000000000000000000000000000",
 "alloc": {
  "0000000000000000000000000000000000001000": {
   "balance": "0x0",
   "code": "0x<data>" // copiare da amoy
  },
  "0000000000000000000000000000000000001001": {
   "balance": "0x0",
   "code": "0x<data>" // copiare da amoy
  },
  "0000000000000000000000000000000000001010": {
   "balance": "0x204fcd4f31349d83b6e00000",
   "code": "0x<data>" // copiare da amoy
  },
  "048d975e40d9d9e8931b9ec38f404b8e36be3218": {
   "balance": "0x3635c9adc5dea00000" // 1000 ether
  },
  "f5e55a3e66d028c59c12185e2e51cdafe2c53baf": {
   "balance": "0x3635c9adc5dea00000" // 1000 ether
  }
 },
 "number": "0x0",
 "gasUsed": "0x0",
 "parentHash": "0x0000000000000000000000000000000000000000000000000000000000000000"
}
```

## Erigon Configuration

First, create the local chain using the following command:

```bash
./bin/erigon --chain=bor-devnet init --datadir ./erigon_data/datadir_1 ./erigon_data/genesis.json
```

Set the same Heimdall validator account in Erigon, then run Erigon with the following command:

```bash
./bin/erigon --datadir ./erigon_data/datadir_1 \
 --chain=bor-devnet --networkid=2999 \
 --http --private.api.addr=localhost:9090 \
 --http.api=eth,erigon,web3,net,debug,trace,txpool,parity,admin \
 --http.corsdomain="*" --bor.heimdall=http://localhost:1317 \
 --mine --miner.etherbase=0x048d975e40d9d9e8931b9ec38f404b8e36be3218 \
 --torrent.port 42069
```

## Bor Configuration

Import the private keys of the Heimdall validators into Bor by running the following command:

```bash
./bin/bor account import -datadir ./erigon_data/bor_datadir_1 scripts/out/privatekey.txt
```

Create a file containing the password for the imported key and save it in `erigon_data/password.txt`.

Run Bor on the first Heimdall node using the command:

```bash
./bin/bor server -chain ./erigon_data/genesis.json \
  --datadir ./erigon_data/bor_datadir_1 \
  --bor.heimdall=http://localhost:1317 \
  --mine \
  --miner.etherbase="0x048d975e40d9d9e8931b9ec38f404b8e36be3218" \
  --allow-insecure-unlock \
  --bor.withoutheimdall=false \
  --bor.heimdallgRPC "localhost:3132" \
  --port 30303 \
  --grpc.addr :3131 \
  --bor.logs true \
  --http --http.addr "localhost" --http.port "8545" \
  --http.api "eth,net,web3,txpool,debug,bor" \
  --http.corsdomain "*" --http.vhosts "*"
  --password ./erigon_data/password.txt
```


## Commands

Saved some commands for startup the nodes, you can find them in the [scripts](./commands) directory.

